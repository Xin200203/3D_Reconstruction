# === 0. ä»£ç åº“ä¸Šä¸‹æ–‡ï¼ˆESAM v2ï¼‰ ===
# â”œâ”€â”€ oneformer3d/
# â”‚   â”œâ”€â”€ mink_unet.py               # 3D Sparse U-Net (Res16UNet34C)
# â”‚   â”œâ”€â”€ bi_fusion_encoder.py       # ðŸ†• å°†è¦å®žçŽ°
# â”‚   â”œâ”€â”€ mixformer3d.py             # ä¸»å¹² Detectorï¼Œæå–ç‚¹ç‰¹å¾æŽ¥å£
# â”‚   â”œâ”€â”€ img_backbone.py            # ViT-B/16 æå– 2D patch feat
# â”‚   â””â”€â”€ __init__.py
# â””â”€â”€ Bi_fusion_encoder/             # æ–‡æ¡£ & composer

# === 1. ä»»åŠ¡ç›®æ ‡ ===
# "Bi-Fusion Encoder"ï¼šå•å¸§åŒæ­¥ç¼–ç  2D è¯­ä¹‰ä¸Ž 3D å‡ ä½•
#   1. è¾“å‡º 96-d ç‚¹ç‰¹å¾ `feat_fusion` ï¼ˆä¾› Decoder & Slot-Transformerï¼‰
#   2. å‘å¸ƒç½®ä¿¡åº¦ `conf_2d` åŠ 32-d `pe_xyz` æ–¹ä¾¿å¯è§†åŒ– / æ¶ˆèž
#   3. å¼•å…¥ CLIP-Cons æ­£åˆ™ï¼Œåœ¨é˜¶æ®µ-I é™æ€å›¾é¢„è®­ç»ƒä¸­ä½¿ç”¨

# === 2. å…³é”®æ¨¡å—æ‹†è§£ ===
# æ–‡ä»¶: oneformer3d/bi_fusion_encoder.py
# ç±»  : BiFusionEncoder
#
# â”Œâ”€ 2.1 2D è¯­ä¹‰åˆ†æ”¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ a) ViT-B/16 (CLIP)                 â€“> (H/16,W/16,768)    â”‚
# â”‚ b) PixelShuffleÃ—2 + Conv1Ã—1        â€“> (H/8 ,W/8 ,256)    â”‚
# â”‚ c) æ·±åº¦æŠ•å½±æŠ½æ ·(å¯å¾® gather)        â€“> F_2D (N_vis,256)    â”‚
# â”‚ d) Linear256â†’128 + ReLU                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€ 2.2 3D å‡ ä½•åˆ†æ”¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ a) Res16UNet34C encoder  (æ—  Memory)   â€“> (N_p,128)       â”‚
# â”‚ b) Tiny-SA Neck Ã—2  (é‚»åŸŸ r=0.3 m)     â€“> (N_p,128)       â”‚
# â”‚    â€‘> å®žçŽ°ä¸º `TinySANeck(in=128,h=128,nhead=4)`            â”‚
# â”‚ c) Linear128â†’128 + ReLU                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”Œâ”€ 2.3 Geo-PE (64 d) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ â‘  xyz_w               : 3                                â”‚
# â”‚ â‘¡ sin/cos(2^{k}Â·xyz) k=0â€¦7 : 3Ã—2Ã—8 = 48                 â”‚
# â”‚ â‘¢ bbox size (w h l)   : 3                                â”‚
# â”‚ â‘£ ç›¸æœº Î”pose (R6 + t3): 9                                â”‚
# â”‚ â‘¤ height h            : 1                                â”‚
# â”‚ åˆè®¡ 3+48+3+9+1 = 64                                    â”‚
# â”‚ MLP_pe 64â†’32 + ReLU                                      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# 2.4 ç»´åº¦å¯¹é½ & é—¨æŽ§èžåˆ
#   â€¢ 2D:  [F_2D128 || PE32]  â€“> Linear160â†’96
#   â€¢ 3D:  [F_3D128 || PE32]  â€“> Linear160â†’96
#   â€¢ FusionGate:  gate = Ïƒ(MLP_g192â†’96)          (é€šé“é—¨æŽ§)
#                  feat_fusion = gateâŠ™F2D96 + (1-gate)âŠ™F3D96
#   â€¢ conf_2d = gate.mean(dim=-1, keepdim=True)
#
# 2.5 è¾“å‡º Dict
#   {
#     'feat_fusion': List[Tensor](B,N_p,96),
#     'conf_2d': List[Tensor](B,N_p,1),
#     'pe_xyz': List[Tensor](B,N_p,32)
#   }

# === 3. ESAM é›†æˆæ–¹æ¡ˆ ===
# â€¢ ä¿®æ”¹ `mixformer3d.extract_feat()`
#     åŽŸ: point_features = backbone(field.sparse())
#     æ–°: encoder_out = self.bi_encoder(points, imgs, cam_info)
#         point_features = encoder_out['feat_fusion']
#         (å…¶ä½™ all_xyz_w ä¸å˜)
# â€¢ `BiFusionEncoder` åœ¨æ¨¡åž‹ `__init__` ä¸­ä»¥ `self.bi_encoder = MODELS.build(...)` åˆ›å»ºã€‚

# === 4. æŸå¤±å‡½æ•° ===
# æ–‡ä»¶: oneformer3d/bife_clip_loss.py   (æ–°å»º)
# ç±»  : ClipConsCriterion
#   forward(fusion_feat, clip_feat_detach) â†’
#       loss_clip = Î»_c * (1 - cosine_sim).mean
# æ•´åˆ: åœ¨ `mixformer3d.loss()` :
#       if self.enable_clip_loss:
#           losses.update(self.clip_criterion(fusion_feat, clip_feat_detach))

# === 5. ä¾èµ–ä¸ŽçŽ¯å¢ƒ ===
# â€¢ `open_clip_torch>=2.22`  (requirements.txt)  â€“ ViT-B/16
# â€¢ æ˜¾å­˜ä¼°è®¡ï¼šViT çº¦ 350 MiB (fp16)ï¼ŒTiny-SA < 200 MiBã€‚

# === 6. å¼€å‘æ­¥éª¤ ===
# S1  æ–°å»º  oneformer3d/bi_fusion_encoder.py
#     - CLIPWrapper (freeze except last 2 blocks)
#       ç¤ºä¾‹åŠ è½½ï¼š
#       ```python
#       import open_clip
#       model, _, preprocess = open_clip.create_model_and_transforms(
#           'ViT-B-16', pretrained='openai', cache_dir='~/.cache/clip')
#       vision_encoder = model.visual  # ä»…è§†è§‰åˆ†æ”¯
#       vision_encoder.eval()          # å†»ç»“
#       for n, p in vision_encoder.named_parameters():
#           p.requires_grad = n.startswith('blocks') and n.split('.')[1] in {'10','11'}
#       ```
#     - build_geo_pe util
#     - FusionGate & forward()
# S1a  util  build_uv_index(points_cam, intr, extr, img_shape)
#       - è¿”å›ž Tensor idx_vis (N_vis) ä¸Ž uv (N_vis,2) (åƒç´ åæ ‡)
#       - ä½¿ç”¨ torch.round & valid mask (0<=u<W,0<=v<H,|d_img - d_depth|<Îµ)
# S1b  sampler sample_img_feat(clip_feat, uv)  â†’ F2D(N_vis,256)
#       - ä½¿ç”¨ bilinear_grid_sampleï¼Œå¯å¾®
# S2  å®žè£… Tiny-SA Neck (å¯æ”¾åŒæ–‡ä»¶æˆ– tiny_sa.py)
# S3  mixformer3d.py â†’ extract_feat ä¿®æ”¹ï¼›æ¨¡åž‹ __init__ ä¸­å¢žåŠ  bi_encoder
# S4  æ–°å»º bife_clip_loss.py å¹¶æ³¨å†Œ
# S5  configs/ESAM/Bi_fusion_encoder_*.py å¤åˆ¶åŽŸ online_scannet é…ç½®å¹¶æ›¿æ¢ encoder / æ·»åŠ  clip_loss
# S6  å•å…ƒæµ‹è¯• test/test_bi_encoder.py
# S7  æ–‡æ¡£ docs/bi_fusion_encoder.md è¯´æ˜Ž & ablation

# === 7. æ³¨æ„ç‚¹ ===
# â€¢ æŠ•å½±ç´¢å¼•ï¼šç”¨ `torch.round(KÂ·xyz/z)` å¾—åˆ° uvï¼Œå†ç”¨æ·±åº¦å·® & occ-mask è¿‡æ»¤ï¼›ç´¢å¼•è¡¨ä¿å­˜åœ¨ DataPipelineï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
# â€¢ Tiny-SA åªä½œç”¨åœ¨ lowest resolution (â‰ˆ3k points)ï¼Œforward å‰ downsample(FPS) å† upsample via nearest; ä¸Žå®žçŽ°æ–¹æ³•.md å®Œå…¨ä¸€è‡´ã€‚
# â€¢ è®­ç»ƒé˜¶æ®µ-Iï¼šä»… forward BiFusionEncoder + ClipConsCriterionï¼›ä¸è·‘ Decoder/Slot éƒ¨åˆ†ã€‚
# â€¢ è®­ç»ƒé˜¶æ®µ-IIï¼šåŠ è½½é˜¶æ®µ-I æƒé‡ï¼Œè”åˆæ‰€æœ‰ä»»åŠ¡ finetuneã€‚

# END ======================================================