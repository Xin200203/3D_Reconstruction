# === 0. ä»£ç åº“ä¸Šä¸‹æ–‡ ===
# ESAM çœŸå®ç›®å½•ï¼ˆç›¸å¯¹ repo æ ¹ï¼‰
# â”œâ”€â”€ oneformer3d/                # ç°æœ‰ç½‘ç»œæ¨¡å—ï¼ˆbackbone / decoder / merge ç­‰ï¼‰
# â”‚   â”œâ”€â”€ mink_unet.py
# â”‚   â”œâ”€â”€ query_decoder.py
# â”‚   â”œâ”€â”€ instance_merge.py
# â”‚   â”œâ”€â”€ instance_criterion.py   # å®ä¾‹çº§æŸå¤±
# â”‚   â””â”€â”€ __init__.py
# â”œâ”€â”€ time_divided_transformer/   # ğŸ†• è§„åˆ’ä¸­çš„è·¨å¸§æ¨¡å—ä¸è¯´æ˜æ–‡æ¡£
# â”œâ”€â”€ configs/                    # è®­ç»ƒ / æ¨ç†é…ç½®
# â””â”€â”€ docs/

# === 1. ä»»åŠ¡ç›®æ ‡ ===
# å®ç° â€œè·¨å¸§ Transformerâ€ (Inter-frame Slot-Transformer)ï¼š
#   â€¢ åŠ¨æ€åˆ·æ–° Memory slot ç‰¹å¾
#   â€¢ è¾“å‡ºæ³¨æ„åŠ›çŸ©é˜µæŒ‡å¯¼å®ä¾‹çº§åŒ¹é… / èåˆ
# è¦æ±‚ï¼š
#   â€¢ ä»…æ›´æ–°ç‰¹å¾ï¼Œä¸ä¿®æ”¹ç‚¹äº‘å‡ ä½•
#   â€¢ å‡ ä½•åç½® (sin-cos xyz + bbox size + height) æ³¨å…¥åˆ° Q/K
#   â€¢ ä¸€è‡´æ€§ã€åŒ¹é…ç›‘ç£æŸå¤±æ¥å…¥ instance_criterion

# === 2. æ¶æ„è¦ç‚¹ï¼ˆç…§æ­¤ç¼–ç ï¼‰ ===
#   æ–‡ä»¶: oneformer3d/time_divided_transformer.py
#   ç±»  : TimeDividedTransformer
#   è¾“å…¥:  Q = [Nc,D], P_c=[Nc,9]  å½“å‰å¸§ instance feat & geom
#          K = [Nm,D], P_m=[Nm,9]  Memory slot feat & geom
#          mask_mem=[Nm]           0/1
#   é€»è¾‘:
#     â€¢ L=3 å±‚ Geometry-biased Cross-Attention (G-XCA)
#         Î”_ij = MLP([P_c_i || P_m_j]) â†’ scalar
#         attn_ij = softmax((QW_q Â· KW_k^T)/âˆšd  + Î²Â·Î”_ij)
#         output = Î£ attn_ij Â· V_j
#         æ›´æ–° Q ç”¨ GRU(q_i, output_i)
#     â€¢ å±‚ååšä¸€æ¬¡ Point-wise Self-Attention åŠ å¼ºå¸§å†…ä¸€è‡´
#     â€¢ æœ€åä¸€å±‚è¾“å‡º:
#         A = attn  (Nc Ã— Nm)  â€”> ä¾›å¤–éƒ¨åŒ¹é…
#         Q_new    (Nc Ã— D)   â€”> å†™å…¥ Memoryï¼ˆEMAï¼‰
#
#   å…¬å¼€æ–¹æ³•:
#     forward(Q, K, P_c, P_m, mask_mem) -> (A, Q_new)

# === 3. å¤ç”¨ ESAM ä»£ç  ===
#   â€¢ ç°æœ‰æ—¶åºæ›´æ–°é€»è¾‘ä½äº `oneformer3d/instance_merge.py::OnlineMerge`
#     å…¶ä¸­å·²å®ç°åŸºäºæŸ¥è¯¢å‘é‡ä¸ IoU çš„åœ¨çº¿èåˆã€‚
#   â€¢ TimeDividedTransformer å°†åœ¨æ¨ç†é˜¶æ®µ **æ›¿æ¢** OnlineMerge å†…çš„
#     `mix_scores = query_feat * xyz_scores` è®¡ç®—ï¼š
#       - OnlineMerge æ–°å¢å¯é€‰è°ƒç”¨ `tformer.forward(Q, K, ...)` è·å–
#         `attn_matrix`ï¼Œå†ç”¨é˜ˆå€¼ / åŒˆç‰™åˆ©åŒ¹é…ã€‚
#   â€¢ å¤ç”¨çš„ utilï¼š `instance_merge.OnlineMerge._bbox_pred_to_bbox` ç­‰ã€‚

# === 4. æŸå¤±å‡½æ•°æ¥å£ ===
#   â€¢ ç¼–è¾‘ `oneformer3d/instance_criterion.py`ï¼š
#       - æ–°å¢ build_crossframe_loss(cfg)
#           * äº¤å‰ç†µ (Hungarian label)  -> L_match
#           * InfoNCE ä¸€è‡´æ€§           -> L_cons
#       - åœ¨ forward() é‡Œæ¥å— A, gt_ids è®¡ç®—å¹¶åŠ æƒ
#   â€¢ åœ¨ models/__init__.py é‡Œæ³¨å†Œ TimeDividedTransformerï¼Œä¾¿äºä¸»å¹²è°ƒç”¨ã€‚

# === 5. æ–‡ä»¶/æ–‡æ¡£ç»´æŠ¤ ===
#   â€¢ æ–°å»º docs/time_divided_transformer.md
#       - åŒ…å«: è®¾è®¡åŠ¨æœºã€å…¬å¼ã€è°ƒç”¨ç¤ºä¾‹
#       - æ¯æ¬¡ä»£ç  push æ—¶åŒæ­¥æ›´æ–°å…³é”®å˜æ›´
#
# === 6. æ­¥éª¤æ‹†è§£ ===
# â”Œâ”€ Step-1: scaffold `oneformer3d/time_divided_transformer.py`
# â”‚         å®ç° TimeDividedTransformer.forward & _layer (G-XCA)
# â”œâ”€ Step-2: åœ¨ models/__init__.py é‡Œå¯¼å‡º
# â”œâ”€ Step-3: ä¿®æ”¹ `oneformer3d/instance_merge.py`
# â”‚         â€¢ åœ¨ `OnlineMerge.__init__` æ³¨å…¥ transformer æ¨¡å‹å¥æŸ„
# â”‚         â€¢ åœ¨ `merge()` ä¸­è°ƒç”¨ `self.tformer.forward(...)`
# â”‚           æ›¿ä»£åŸ mix_scores è®¡ç®—ï¼Œè¾“å‡º attn çŸ©é˜µ A
# â”‚         â€¢ ç»§ç»­ä½¿ç”¨åŒˆç‰™åˆ©æˆ–é˜ˆå€¼åŒ¹é…é€»è¾‘ä¸å˜
# â”œâ”€ Step-4: criterion/instance_criterion.py
# â”‚         æ·»åŠ  L_match & L_cons
# â”œâ”€ Step-5: å•å…ƒæµ‹è¯•
# â”‚   â€¢ test/test_td_transformer.py
# â”‚       - éšæœºè¾“å…¥ç»´åº¦å¯¹é½ï¼Œassert A è¡Œ softmax, shape OK
# â”‚       - EMA æ›´æ–°å Memory å˜åŒ–
# â””â”€ Step-6: docs/time_divided_transformer.md åˆç‰ˆè½åœ°
#
# é¢„æœŸå•å…ƒæµ‹è¯• <60sï¼Œæœ¬æ­¥éª¤å·¥ä½œé‡ ~ 8h

# === 7. å¼€å§‹ç¼–ç  ===
# ä¾æ¬¡å®Œæˆ Step-1 â€¦ Step-6ï¼Œå¿…è¦æ—¶åœ¨ PR æè¿°é‡Œå¼•ç”¨æœ¬ promptã€‚
