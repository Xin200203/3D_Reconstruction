1: # BiFusionEncoder 组件检查清单

> 目标：罗列训练/推理链路上的所有关键部件与待检查项，作为性能-正确性优化的对照表。

---
## 0 数据侧
- [ ] 原始 ScanNet 文件齐备（mesh / posed_images / segs / aggregation）
- [ ] 预处理脚本已执行（points/、super_points/、mask npy、info.pkl）
- [ ] RGB-D 对齐正确：intrinsics、extrinsics、axis_align_matrix
- [ ] clip_conv1 离线特征（可选）已缓存 & 校验尺寸
- [ ] 数据增广参数（flip / rot / color jitter / elastic）符合论文设置

## 1 Dataset & DataLoader
- [ ] `ScanNetSVData.get_infos` 字段完整：pts_path / sp_path / sem_mask / ins_mask / img_path / intrinsics / extrinsics
- [ ] Pipeline 中 `PointSegClassMapping` 类别映射正确 (C=20/200)
- [ ] `AddSuperPointAnnotations` 生成 `gt_sp_masks` 与 `sp_pts_mask` 对齐
- [ ] batch_size / num_workers / persistent_workers 配置合理

## 2 BiFusionEncoder
### 2.1 2D 分支
- [ ] `clip_visual.conv1` 权重冻结 (freeze_blocks=0)
- [ ] 输入分辨率 H,W 为 16 的倍数 or 插值到 640×480
- [ ] PixelShuffle×2 输出 (B,192,H/8,W/8)
- [ ] `conv_reduce`→256d → **Linear 128d** 后是否归一化 / BN
- [ ] TinySA2D 开关与参数（heads/radius/k）

### 2.2 3D 分支
- [ ] `Res16UNet34C` in/out channels (3→96)
- [ ] Sparse tensor voxel_size 与 Dataset elastic_coords 一致 (0.02)
- [ ] TinySANeck 两层参数（radius,max_k,sample_ratio）
- [ ] `lin3d` 输出 128d 与 2D 对齐

### 2.3 几何位置编码
- [ ] `build_geo_pe` 输入：xyz_world / bbox_size / pose_delta / height
- [ ] `pe_mlp` 输出 32d；数值范围检查

### 2.4 融合 & 输出
- [ ] `FusionGate` 通道与激活函数
- [ ] `lin2d96` `lin3d96` 维度一致
- [ ] 返回 dict 键：feat_fusion / conf_2d / pe_xyz / clip_global

## 3 Decoder & 头部
- [ ] `GeoAwarePooling` 参数 channel_proj=96
- [ ] `ScanNetMixQueryDecoder` 层数 / cross_attn_mode / mask_pred_mode
- [ ] 查询数设置：instance / semantic / panoptic

## 4 Criterion / Loss
- [ ] SemanticCriterion(ignore_idx, loss_weight)
- [ ] MixedInstanceCriterion 权重 [w_cls,w_bce,w_dice,w_score]
- [ ] Matcher 代价权重 & top-k
- [ ] Dice 修正因子（batch_size!=4）
- [ ] ClipConsCriterion 是否启用 & loss_weight

## 5 训练配置
- [ ] Optimizer: AdamW (lr, weight_decay)
- [ ] LR scheduler: Cosine / Linear warm-up (iters)
- [ ] AMP 与 GradScaler 状态
- [ ] Hook：Checkpoint, Logger, PartialLoadHook (预训练路径)
- [ ] EMA / SWA（可选）

## 6 评估 & Metric
- [ ] UnifiedSegMetric ignore_index / thing & stuff ids
- [ ] mIoU / PQ 公式实现验证
- [ ] val_dataloader batch_size=1, shuffle=False

## 7 推理 & 合并
- [ ] Online MergeHead 参数 (overlap thr, nms)
- [ ] CPU ⇄ GPU memory 占用

## 8 性能 Profiling
- [ ] 单卡 forward-backward FPS
- [ ] 显存峰值 (encoder    / decoder)
- [ ] 算子耗时 Top-10 (torch.profiler)

## 9 代码质量
- [ ] Pyright 0 error / 0 warning
- [ ] Black 格式化 & isort
- [ ] 单元测试全部通过 (tiny_sa / encoder / loss / dataset)

---

## 2025-07-06 自检结果

| 条目 | 子项 | 结果 |
|------|------|------|
| 0 数据 | 原始文件 / 预处理 / RGB-D 对齐 / clip cache / 增广 | ❓ 需运行时确认 |
| 1 Dataset | 字段完整 | ✔ |
|  | 类别映射 / SP 注释 | ✔ |
|  | DataLoader 参数 | ❓ |
| 2.1 2D | conv1 冻结 | ✔ |
|  | PixelShuffle & conv_reduce→128 | ✔ |
|  | TinySA2D 实现 | ✔ (可选) |
| 2.2 3D | Unet 3→96→128 | ✔ |
|  | TinySANeck | ✔ |
|  | voxel_size 对齐 | ✔ |
| 2.3 PE | build_geo_pe + MLP32 | ✔ |
| 2.4 融合 | lin2d96/lin3d96 & FusionGate | ✔ |
| 3 Decoder | Pooling / Decoder cfg | ✔ |
| 4 Loss | Semantic / Instance / Matcher / Dice 修正 | ✔ |
|  | ClipConsCriterion | ❓ 默认未启用 |
| 5 训练 | Optimizer / AMP / Hooks | ✔ |
|  | EMA/SWA | ❓ 未启用 |
| 6 Metric | UnifiedSegMetric 配置 | ✔ |
| 7 推理合并 | Online MergeHead | ❓ 基线未用 |
| 8 Profiling | FPS / 显存 / profiler | ❓ 待实测 |
| 9 代码质量 | Pyright 0 error；instance_merge⚠ | ⚠ |

✔=代码层面满足 ❓=需数据或运行时验证 ⚠=部分警告/可优化

请在迭代过程中逐项打勾或补充。
