本表用于汇总 `1225单帧物体重复去除.md` 中各轮单帧 ablation 的结果，便于横向对比与决策（不混变量、每轮排除一个假设）。

数据来源：
- AP（cat-agnostic）：`tools/test.py --cat-agnostic` 的终端输出表格
- 诊断 JSON：`instance_error_diagnostics.json`
- 诊断 NPZ：`instance_error_diagnostics_raw.npz`（用于 `pred_strong0_rate` 等）

---

# Baseline（Stage 0）

后处理参数（来自 `configs/ESAM_CA/ESAM_sv_scannet200_CA_dino.py` 的 `model.test_cfg`）：
- `topk_insts=100`, `inst_score_thr=0.0`, `sp_score_thr=0.4`, `npoint_thr=100`
- `obj_normalization=True`, `nms=True`, `matrix_nms_kernel=linear`

AP（cat-agnostic）：
- `AP_0.25=0.8813`, `AP_0.50=0.7542`, `AP=0.5306`

诊断（来自 `instance_error_diagnostics.json` / `npz`）：

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | nms_kernel | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit_ge2 | hit0@0.1\_ge100 | best0\_ge100 | pred_strong0 | purity_low |
|---|---|---:|---:|---:|---:|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| stage0_baseline | yes | 0.40 | 100 | 0.00 | 100 | True | linear | 0.8813 | 0.7542 | 0.5306 | 0.08140 | 0.65958 | 0.00444 | 0.000199 | 0.52638 | 0.27534 |

字段说明（与 `1225单帧物体重复去除.md` 对齐）：
- `best(0,0.5)_ge100`：`miss_rates.gt_best_iou_0_0p5_rate_ge_100`
- `hit_ge2`：`diagnosis.rates.gt_hit_ge2_rate`
- `hit0@0.1_ge100`：`miss_rates.gt_hit_zero_rate_iou_lo_ge_100`
- `best0_ge100`：`miss_rates.gt_best_iou_zero_rate_ge_100`
- `purity_low`：`diagnosis.rates.purity_low_rate`
- `pred_strong0`：`mean(pred_strong_gt_cnt==0)`（来自 `npz`）

---

# 实验记录模板（后续每轮填一行）

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | nms_kernel | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit_ge2 | hit0@0.1\_ge100 | best0\_ge100 | pred_strong0 | purity_low |
|---|---|---:|---:|---:|---:|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| stage1_sp0p50 | yes | 0.50 | 100 | 0.00 | 100 | True | linear | 0.8816 | 0.7542 | 0.5323 | 0.08273 | 0.65129 | 0.00504 | 0.000265 | 0.53085 | 0.26301 |
| stage1_sp0p45 | yes | 0.45 | 100 | 0.00 | 100 | True | linear | 0.8815 | 0.7542 | 0.5316 | 0.08286 | 0.65579 | 0.00498 | 0.000265 | 0.52879 | 0.26911 |
| stage1_sp0p40 | yes | 0.40 | 100 | 0.00 | 100 | True | linear | 0.8816 | 0.7539 | 0.5304 | 0.08180 | 0.65843 | 0.00478 | 0.000199 | 0.52644 | 0.27521 |
| stage1_sp0p35 | yes | 0.35 | 100 | 0.00 | 100 | True | linear | 0.8816 | 0.7523 | 0.5295 | 0.08113 | 0.66211 | 0.00411 | 0.000066 | 0.52481 | 0.28172 |
| stage1_sp0p30 | yes | 0.30 | 100 | 0.00 | 100 | True | linear | 0.8817 | 0.7523 | 0.5280 | 0.08093 | 0.66452 | 0.00405 | 0.000066 | 0.52211 | 0.28843 |
| stage1_sp0p25 | yes | 0.25 | 100 | 0.00 | 100 | True | linear | 0.8811 | 0.7508 | 0.5255 | 0.08186 | 0.66821 | 0.00398 | 0.000066 | 0.51973 | 0.29678 |
| stage1_sp0p20 | yes | 0.20 | 100 | 0.00 | 100 | True | linear | 0.8811 | 0.7506 | 0.5233 | 0.08160 | 0.67057 | 0.00405 | 0.000066 | 0.51653 | 0.30630 |

---

# Stage 2（候选预算）：结果记录模板

Stage 2 固定 `sp_score_thr` 建议从 Stage 1 选一个“在线友好甜点”（示例：`sp_thr=0.45`，以你实际使用为准）。

## Stage 2.1：topk_insts sweep（固定 inst_score_thr=0.0）

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | nms_kernel | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit_ge2 | hit0@0.1\_ge100 | best0\_ge100 | pred_strong0 | purity_low |
|---|---|---:|---:|---:|---:|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| stage2_topk100 | yes | 0.45 | 100 | 0.00 | 100 | True | linear | 0.8816 | 0.7538 | 0.5314 | 0.08259 | 0.65574 | 0.00484 | 0.000265 | 0.52875 | 0.26970 |
| stage2_topk50 | yes | 0.45 | 50 | 0.00 | 100 | True | linear | 0.8806 | 0.7515 | 0.5301 | 0.09453 | 0.56564 | 0.00829 | 0.000862 | 0.52387 | 0.22951 |
| stage2_topk30 | yes | 0.45 | 30 | 0.00 | 100 | True | linear | 0.8790 | 0.7460 | 0.5267 | 0.11158 | 0.40090 | 0.01632 | 0.003118 | 0.51779 | 0.20109 |
| stage2_topk20 | yes | 0.45 | 20 | 0.00 | 100 | True | linear | 0.8709 | 0.7371 | 0.5219 | 0.13188 | 0.26686 | 0.03058 | 0.006966 | 0.48271 | 0.19043 |

## Stage 2.2：inst_score_thr sweep（固定 topk_insts=50）

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | nms_kernel | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit_ge2 | hit0@0.1\_ge100 | best0\_ge100 | pred_strong0 | purity_low |
|---|---|---:|---:|---:|---:|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| stage2_inst0p00 | yes | 0.45 | 50 | 0.00 | 100 | True | linear | 0.8807 | 0.7514 | 0.5302 | 0.09420 | 0.56543 | 0.00823 | 0.000862 | 0.52410 | 0.22987 |
| stage2_inst0p05 | yes | 0.45 | 50 | 0.05 | 100 | True | linear | 0.8757 | 0.7490 | 0.5268 | 0.10342 | 0.24061 | 0.01300 | 0.002786 | 0.60833 | 0.23309 |
| stage2_inst0p10 | yes | 0.45 | 50 | 0.10 | 100 | True | linear | 0.8739 | 0.7451 | 0.5244 | 0.11450 | 0.13607 | 0.01745 | 0.003715 | 0.57694 | 0.22188 |
| stage2_inst0p20 | yes | 0.45 | 50 | 0.20 | 100 | True | linear | 0.8698 | 0.7373 | 0.5202 | 0.13162 | 0.05856 | 0.02574 | 0.006767 | 0.50224 | 0.20625 |
| stage2_inst0p25 | yes | 0.45 | 50 | 0.25 | 100 | True | linear | 0.8670 | 0.7326 | 0.5177 | 0.13812 | 0.04202 | 0.03105 | 0.008359 | 0.47073 | 0.20057 |

---

# Stage 3（排序偏好）：obj_normalization on/off（工作点：sp=0.45, topk=50, inst=0.0）

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | nms_kernel | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit_ge2 | hit0@0.1\_ge100 | best0\_ge100 | pred_strong0 | purity_low |
|---|---|---:|---:|---:|---:|---|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| stage3_objnorm_on | yes | 0.45 | 50 | 0.00 | 100 | True | linear | 0.8798 | 0.7510 | 0.5299 | 0.09420 | 0.56504 | 0.00816 | 0.000929 | 0.52404 | 0.22958 |
| stage3_objnorm_off | yes | 0.45 | 50 | 0.00 | 100 | False | linear | 0.8795 | 0.7433 | 0.5028 | 0.09440 | 0.56554 | 0.00836 | 0.000862 | 0.52388 | 0.22950 |

---

# Oracle / Rank “硬证据”诊断（oracle@K + best-IoU-rank）

说明：
- 目的：回答“好候选是不存在（模型能力问题）还是存在但 rank 靠后（选择/排序信号问题）”
- 指标来源：`instance_error_diagnostics.json` 中的 `oracle` 与 `best_iou_rank`
- `oracle@K`：在“同一帧输出候选”中，按 score 取前 K 个预测时，每个 GT 能达到的最大 IoU（oracle 视角的上界曲线）

对应 work-dir：
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_oraclefix_sp0p45_topk50_inst0_objnorm_on`
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_oraclefix_sp0p45_topk100_inst0_objnorm_on`

## 核心数值（只看 ≥100 点桶 ge_100）

| Exp | sp_thr | topk | inst_thr | obj_norm | AP25 | AP50 | AP | best(0,0.5)\_ge100 | hit0@0.1\_ge100 | best0\_ge100 | hit\_ge2 | oracle@20\_ge100(hit@0.5) | oracle@50\_ge100(hit@0.5) | oracle@100\_ge100(hit@0.5) | best-rank\_ge100 median | best-rank\_ge100 p90 | best-rank\_ge100 p95 | best-rank\_ge100 ≤10 | best-rank\_ge100 >50 | pred_strong0 | purity_low |
|---|---:|---:|---:|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| oraclefix_topk50 | 0.45 | 50 | 0.00 | True | 0.8798 | 0.7515 | 0.5302 | 0.09407 | 0.00829 | 0.000862 | 0.56597 | 0.88364 | 0.90507 | 0.90507 | 7 | 38 | 42 | 0.57815 | 0.00000 | 0.52410 | 0.22932 |
| oraclefix_topk100 | 0.45 | 100 | 0.00 | True | 0.8815 | 0.7544 | 0.5315 | 0.08226 | 0.00484 | 0.000265 | 0.65590 | 0.88450 | 0.91177 | 0.91747 | 11 | 59 | 71 | 0.49443 | 0.14701 | 0.52866 | 0.26940 |

---

# Stage 6（Rerank + Copy-Suppress）：结果记录（score_source=instance_select_scores）

说明：
- 本 Stage 固定 `sp=0.45, topk_insts=100, inst_thr=0.0, obj_norm=True`，并在 diagnostics 使用 `score_source=instance_select_scores`，使 `oracle@K / best-IoU-rank` 对齐“实际参与 topK 选择的分数”（而非 obj_norm 后的最终分数）。
- `oracle@K_ge100` 在 `topk=50` 形态下近似等价于 `1 - miss_ge100`（因为可用预测数量/候选上限决定了 oracle 的上界）。

对应 work-dir：
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_s6_0_baseline`
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_s6_1_copysuppress_only`
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_s6_2_quality_topk50`
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_s6_3_quality_topk50_fallback20`
- `work_dirs/ESAM_sv_scannet200_CA_dino_1225/ESAM_sv_scannet200_CA_dino_eval_s6_4_quality_fallback20_copysuppress`

| Exp | AP25 | AP50 | AP | pred_instances | best(0,0.5)_ge100 | hit0@0.1_ge100 | best0_ge100 | hit_ge2 | oracle@20_ge100 | oracle@50_ge100 | oracle@100_ge100 | best_rank_med_ge100 | best_rank_p90_ge100 | best_rank_gt50_ge100 | purity_low | pred_strong0 |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| s6_0_baseline | 0.88152 | 0.75446 | 0.53176 | 143974 | 0.08246 | 0.00478 | 0.00027 | 0.65568 | 0.67825 | 0.87668 | 0.91727 | 29 | 63 | 0.20008 | 0.26918 | 0.52858 |
| s6_1_copysuppress_only | 0.88111 | 0.75329 | 0.53056 | 98344 | 0.08697 | 0.00571 | 0.00040 | 0.50126 | 0.66180 | 0.91263 | 0.91263 | 22 | 43 | 0.00000 | 0.28578 | 0.62074 |
| s6_2_quality_topk50 | 0.87987 | 0.75215 | 0.53068 | 102240 | 0.09354 | 0.00889 | 0.00080 | 0.57987 | 0.72177 | 0.90567 | 0.90567 | 20 | 40 | 0.00000 | 0.23080 | 0.51164 |
| s6_3_quality_topk50_fallback20 | 0.87971 | 0.75231 | 0.53051 | 102265 | 0.09347 | 0.00902 | 0.00073 | 0.57927 | 0.72608 | 0.90580 | 0.90580 | 20 | 40 | 0.00000 | 0.23038 | 0.51155 |
| s6_4_quality_fallback20_copysuppress | 0.87959 | 0.75232 | 0.53024 | 81244 | 0.09334 | 0.00889 | 0.00086 | 0.45803 | 0.72443 | 0.90580 | 0.90580 | 17 | 33 | 0.00000 | 0.25884 | 0.59416 |

---

# Stage 7（RCS 补位式 Copy-Suppress）：结果记录（v2）

说明：
- Stage7 目标：在不靠 `inst_score_thr` 的情况下，用更大候选池 `N` + 同帧 copy-suppress（IoU>τ 视为拷贝）输出固定预算 `K=50` 的多样候选，降低重复且不剪穿红线。
- 本轮为 v2：`copy_suppress.sort_by=scores` 且 `allow_replace=True / prefer_by=scores / refill=True`，避免 cls-only 排序造成“保错代表”的灾难性掉点。

| Exp | cat-agnostic | sp_thr | topk | inst_thr | npoint_thr | obj_norm | copy_tau | copy_K | AP25 | AP50 | AP | pred_instances | best(0,0.5)\_ge100 | hit0@0.1\_ge100 | best0\_ge100 | hit_ge2 | oracle@50\_ge100 | oracle@100\_ge100 | purity_low | pred_strong0 |
|---|---|---:|---:|---:|---:|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| s7_e1_rcsN100_K50_tau0p90_v2 | yes | 0.45 | 100 | 0.00 | 100 | True | 0.90 | 50 | 0.88124 | 0.75334 | 0.53042 | 98352 | 0.08664 | 0.00604 | 0.00040 | 0.50121 | 0.91296 | 0.91296 | 0.28599 | 0.62078 |
| s7_e2_rcsN200_K50_tau0p90_v2 | yes | 0.45 | 200 | 0.00 | 100 | True | 0.90 | 50 | 0.88147 | 0.75379 | 0.53045 | 98353 | 0.08651 | 0.00577 | 0.00040 | 0.50044 | 0.91310 | 0.91310 | 0.28552 | 0.62066 |
